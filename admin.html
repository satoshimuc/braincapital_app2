<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UNLOCK — Brain Capital 管理画面</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --black: #000; --gray-900: #111; --gray-800: #222; --gray-700: #333;
      --gray-600: #555; --gray-500: #777; --gray-400: #999; --gray-300: #BBB;
      --gray-200: #DDD; --gray-150: #E8E8E8; --gray-100: #F0F0F0;
      --gray-50: #F7F7F7; --white: #FFF;
      --font-sans: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    html { font-size: 15px; -webkit-font-smoothing: antialiased; }
    body { font-family: var(--font-sans); color: var(--gray-800); background: var(--gray-50); line-height: 1.6; }

    /* Layout */
    .admin-header {
      background: var(--white); border-bottom: 1px solid var(--gray-200);
      padding: 16px 32px; display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
    }
    .admin-logo { font-size: 14px; font-weight: 700; letter-spacing: 3px; color: var(--black); }
    .admin-title { font-size: 13px; color: var(--gray-500); font-weight: 500; }
    .admin-container { max-width: 1200px; margin: 0 auto; padding: 32px; }

    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 32px; }
    .stat-card {
      background: var(--white); border: 1px solid var(--gray-200); border-radius: 8px;
      padding: 20px; text-align: center;
    }
    .stat-number { font-size: 32px; font-weight: 700; color: var(--black); line-height: 1; }
    .stat-label { font-size: 12px; color: var(--gray-500); margin-top: 4px; }

    /* Controls */
    .controls {
      display: flex; gap: 12px; align-items: center; margin-bottom: 24px; flex-wrap: wrap;
    }
    .search-input {
      padding: 10px 16px; border: 1px solid var(--gray-200); border-radius: 6px;
      font-family: var(--font-sans); font-size: 13px; color: var(--gray-800);
      background: var(--white); outline: none; min-width: 240px;
    }
    .search-input:focus { border-color: var(--gray-600); }
    .sort-select {
      padding: 10px 16px; border: 1px solid var(--gray-200); border-radius: 6px;
      font-family: var(--font-sans); font-size: 13px; color: var(--gray-800);
      background: var(--white); outline: none; cursor: pointer;
    }
    .btn-export {
      padding: 10px 20px; background: var(--gray-900); color: var(--white); border: none;
      border-radius: 6px; font-family: var(--font-sans); font-size: 13px; font-weight: 600;
      cursor: pointer; margin-left: auto;
    }
    .btn-export:hover { background: var(--gray-700); }
    .btn-danger {
      padding: 10px 20px; background: var(--white); color: #c00; border: 1px solid #c00;
      border-radius: 6px; font-family: var(--font-sans); font-size: 13px; font-weight: 500;
      cursor: pointer;
    }
    .btn-danger:hover { background: #fef2f2; }

    /* Table */
    .table-wrapper {
      background: var(--white); border: 1px solid var(--gray-200); border-radius: 8px;
      overflow-x: auto;
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead { background: var(--gray-50); }
    th {
      padding: 12px 16px; text-align: left; font-weight: 600; color: var(--gray-600);
      font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase;
      border-bottom: 1px solid var(--gray-200); white-space: nowrap;
    }
    td {
      padding: 12px 16px; border-bottom: 1px solid var(--gray-100);
      vertical-align: middle; white-space: nowrap;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--gray-50); }

    .user-cell { display: flex; align-items: center; gap: 10px; }
    .user-avatar {
      width: 32px; height: 32px; border-radius: 50%; background: var(--gray-200);
      flex-shrink: 0; object-fit: cover;
    }
    .user-name { font-weight: 500; color: var(--gray-800); }
    .user-uid { font-size: 11px; color: var(--gray-400); font-family: monospace; }

    .score-cell { font-weight: 600; font-variant-numeric: tabular-nums; }
    .level-badge {
      display: inline-block; padding: 2px 10px; border-radius: 3px;
      font-size: 11px; font-weight: 700; letter-spacing: 1px;
    }
    .level-S { background: var(--gray-900); color: var(--white); }
    .level-A { background: var(--gray-700); color: var(--white); }
    .level-B { background: var(--gray-400); color: var(--white); }
    .level-C { background: var(--gray-200); color: var(--gray-700); }
    .level-D { background: var(--gray-100); color: var(--gray-500); }

    .type-badge {
      display: inline-block; padding: 2px 8px; border: 1px solid var(--gray-300);
      border-radius: 3px; font-size: 11px; font-weight: 600; color: var(--gray-600);
    }

    .date-cell { color: var(--gray-500); font-size: 12px; }

    /* Detail modal */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4); z-index: 200; align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--white); border-radius: 12px; max-width: 560px; width: 90%;
      max-height: 85vh; overflow-y: auto; padding: 32px;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
    .modal-title { font-size: 18px; font-weight: 700; color: var(--black); }
    .modal-close {
      background: none; border: none; font-size: 24px; color: var(--gray-400);
      cursor: pointer; padding: 0 4px; line-height: 1;
    }
    .modal-close:hover { color: var(--gray-800); }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .detail-item { padding: 12px; background: var(--gray-50); border-radius: 6px; }
    .detail-label { font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; }
    .detail-value { font-size: 16px; font-weight: 600; color: var(--gray-800); margin-top: 2px; }
    .detail-section-title { font-size: 13px; font-weight: 600; color: var(--gray-700); margin: 16px 0 8px; }
    .detail-bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .detail-bar-label { font-size: 12px; color: var(--gray-600); width: 120px; flex-shrink: 0; }
    .detail-bar-container { flex: 1; height: 8px; background: var(--gray-100); border-radius: 4px; overflow: hidden; }
    .detail-bar { height: 100%; background: var(--gray-700); border-radius: 4px; }
    .detail-bar-score { font-size: 12px; font-weight: 600; color: var(--gray-700); width: 40px; text-align: right; flex-shrink: 0; }

    .empty-state { text-align: center; padding: 64px 32px; color: var(--gray-400); }
    .empty-state-title { font-size: 16px; font-weight: 600; color: var(--gray-600); margin-bottom: 8px; }

    @media (max-width: 768px) {
      .admin-container { padding: 16px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .controls { flex-direction: column; }
      .search-input { min-width: auto; width: 100%; }
      .btn-export { margin-left: 0; width: 100%; }
      .detail-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <header class="admin-header">
    <span class="admin-logo">UNLOCK</span>
    <span class="admin-title">Brain Capital 管理画面</span>
  </header>

  <div class="admin-container">
    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="stat-total">0</div>
        <div class="stat-label">総回答数</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-users">0</div>
        <div class="stat-label">ユニークユーザー</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-avg">—</div>
        <div class="stat-label">平均スコア</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-avg-health">—</div>
        <div class="stat-label">平均 Health</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-avg-skills">—</div>
        <div class="stat-label">平均 Skills</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <input type="text" id="search" class="search-input" placeholder="名前または UID で検索...">
      <select id="sort-select" class="sort-select">
        <option value="date-desc">日時（新しい順）</option>
        <option value="date-asc">日時（古い順）</option>
        <option value="score-desc">スコア（高い順）</option>
        <option value="score-asc">スコア（低い順）</option>
        <option value="name-asc">名前（A→Z）</option>
      </select>
      <button type="button" id="btn-export" class="btn-export">CSV エクスポート</button>
      <button type="button" id="btn-clear" class="btn-danger">全データ削除</button>
    </div>

    <!-- Table -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>ユーザー</th>
            <th>日時</th>
            <th>合計</th>
            <th>Health</th>
            <th>Skills</th>
            <th>ランク</th>
            <th>タイプ</th>
          </tr>
        </thead>
        <tbody id="results-tbody">
        </tbody>
      </table>
      <div id="empty-state" class="empty-state" style="display:none;">
        <div class="empty-state-title">結果データがありません</div>
        <p>ユーザーが診断を完了すると、ここに結果が表示されます。</p>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">詳細</div>
        <button type="button" class="modal-close" id="modal-close">&times;</button>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="js/supabase-config.js"></script>
  <script>
  (function () {
    'use strict';

    // Supabase client
    var sb = null;
    if (typeof SUPABASE_URL !== 'undefined' && typeof SUPABASE_ANON_KEY !== 'undefined' &&
        SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    var CATEGORY_NAMES = {
      A: '睡眠と回復', B: '運動と身体活動', C: 'ストレスとメンタルヘルス',
      D: '栄養と脳の燃料', E: '休息とリカバリー', F: '認知力',
      G: '創造性', H: '対人関係力', I: 'セルフリーダーシップ', J: 'テクノロジーリテラシー'
    };

    var allResults = [];

    // ---- Data Loading (Supabase) ----
    function loadResults() {
      if (!sb) {
        allResults = [];
        renderAll();
        return;
      }

      sb.from('assessment_results')
        .select('*')
        .order('created_at', { ascending: false })
        .then(function (res) {
          if (res.error) {
            console.error('Supabase fetch failed:', res.error.message);
            allResults = [];
          } else {
            // Map snake_case DB columns to camelCase used by rendering
            allResults = (res.data || []).map(function (r) {
              return {
                id: r.id,
                lineUid: r.line_uid,
                displayName: r.display_name,
                pictureUrl: r.picture_url,
                date: r.created_at,
                total: r.total,
                healthTotal: r.health_total,
                skillsTotal: r.skills_total,
                level: r.level,
                levelLabel: r.level_label,
                type: r.type,
                categories: r.categories,
                answers: r.answers,
              };
            });
          }
          renderAll();
        });
    }

    // ---- Stats ----
    function renderStats() {
      var total = allResults.length;
      var uniqueUsers = new Set(allResults.map(function (r) { return r.lineUid; })).size;
      var avgTotal = total > 0 ? (allResults.reduce(function (s, r) { return s + r.total; }, 0) / total).toFixed(0) : '—';
      var avgHealth = total > 0 ? (allResults.reduce(function (s, r) { return s + r.healthTotal; }, 0) / total).toFixed(0) : '—';
      var avgSkills = total > 0 ? (allResults.reduce(function (s, r) { return s + r.skillsTotal; }, 0) / total).toFixed(0) : '—';

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-users').textContent = uniqueUsers;
      document.getElementById('stat-avg').textContent = avgTotal;
      document.getElementById('stat-avg-health').textContent = avgHealth;
      document.getElementById('stat-avg-skills').textContent = avgSkills;
    }

    // ---- Table ----
    function getFilteredSorted() {
      var query = document.getElementById('search').value.toLowerCase();
      var sortBy = document.getElementById('sort-select').value;

      var filtered = allResults.filter(function (r) {
        if (!query) return true;
        return (r.displayName || '').toLowerCase().indexOf(query) !== -1 ||
               (r.lineUid || '').toLowerCase().indexOf(query) !== -1;
      });

      filtered.sort(function (a, b) {
        switch (sortBy) {
          case 'date-desc': return new Date(b.date) - new Date(a.date);
          case 'date-asc': return new Date(a.date) - new Date(b.date);
          case 'score-desc': return b.total - a.total;
          case 'score-asc': return a.total - b.total;
          case 'name-asc': return (a.displayName || '').localeCompare(b.displayName || '');
          default: return 0;
        }
      });

      return filtered;
    }

    function renderTable() {
      var tbody = document.getElementById('results-tbody');
      var emptyState = document.getElementById('empty-state');
      var rows = getFilteredSorted();

      if (rows.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';

      tbody.innerHTML = rows.map(function (r, idx) {
        var d = new Date(r.date);
        var dateStr = d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate() + ' ' +
                      String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
        var avatarHtml = r.pictureUrl
          ? '<img class="user-avatar" src="' + r.pictureUrl + '" alt="">'
          : '<div class="user-avatar"></div>';
        var uidShort = (r.lineUid || '').length > 16
          ? r.lineUid.substring(0, 8) + '...'
          : (r.lineUid || '—');

        return '<tr data-idx="' + idx + '" style="cursor:pointer;">' +
          '<td><div class="user-cell">' + avatarHtml +
            '<div><div class="user-name">' + (r.displayName || '—') + '</div>' +
            '<div class="user-uid">' + uidShort + '</div></div></div></td>' +
          '<td class="date-cell">' + dateStr + '</td>' +
          '<td class="score-cell">' + r.total + ' / 150</td>' +
          '<td class="score-cell">' + r.healthTotal + '</td>' +
          '<td class="score-cell">' + r.skillsTotal + '</td>' +
          '<td><span class="level-badge level-' + r.level + '">' + r.level + '</span></td>' +
          '<td><span class="type-badge">Type ' + r.type + '</span></td>' +
        '</tr>';
      }).join('');
    }

    function renderAll() {
      renderStats();
      renderTable();
    }

    // ---- Detail Modal ----
    function showDetail(record) {
      var overlay = document.getElementById('modal-overlay');
      var body = document.getElementById('modal-body');
      document.getElementById('modal-title').textContent = (record.displayName || '—') + ' の診断結果';

      var d = new Date(record.date);
      var dateStr = d.getFullYear() + '年' + (d.getMonth() + 1) + '月' + d.getDate() + '日 ' +
                    String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');

      var html = '<div class="detail-grid">' +
        '<div class="detail-item"><div class="detail-label">LINE UID</div><div class="detail-value" style="font-size:11px;font-family:monospace;word-break:break-all;">' + (record.lineUid || '—') + '</div></div>' +
        '<div class="detail-item"><div class="detail-label">実施日時</div><div class="detail-value" style="font-size:13px;">' + dateStr + '</div></div>' +
        '<div class="detail-item"><div class="detail-label">総合スコア</div><div class="detail-value">' + record.total + ' / 150</div></div>' +
        '<div class="detail-item"><div class="detail-label">ランク / タイプ</div><div class="detail-value"><span class="level-badge level-' + record.level + '">' + record.level + '</span> <span class="type-badge">Type ' + record.type + '</span></div></div>' +
        '<div class="detail-item"><div class="detail-label">Brain Health</div><div class="detail-value">' + record.healthTotal + ' / 75</div></div>' +
        '<div class="detail-item"><div class="detail-label">Brain Skills</div><div class="detail-value">' + record.skillsTotal + ' / 75</div></div>' +
      '</div>';

      // Category bars
      if (record.categories) {
        html += '<div class="detail-section-title">Brain Health カテゴリ</div>';
        ['A', 'B', 'C', 'D', 'E'].forEach(function (id) {
          var score = record.categories[id] || 0;
          var pct = ((score / 15) * 100).toFixed(0);
          html += '<div class="detail-bar-row">' +
            '<span class="detail-bar-label">' + id + '. ' + CATEGORY_NAMES[id] + '</span>' +
            '<div class="detail-bar-container"><div class="detail-bar" style="width:' + pct + '%"></div></div>' +
            '<span class="detail-bar-score">' + score + '/15</span></div>';
        });
        html += '<div class="detail-section-title">Brain Skills カテゴリ</div>';
        ['F', 'G', 'H', 'I', 'J'].forEach(function (id) {
          var score = record.categories[id] || 0;
          var pct = ((score / 15) * 100).toFixed(0);
          html += '<div class="detail-bar-row">' +
            '<span class="detail-bar-label">' + id + '. ' + CATEGORY_NAMES[id] + '</span>' +
            '<div class="detail-bar-container"><div class="detail-bar" style="width:' + pct + '%"></div></div>' +
            '<span class="detail-bar-score">' + score + '/15</span></div>';
        });
      }

      body.innerHTML = html;
      overlay.classList.add('active');
    }

    // ---- CSV Export ----
    function exportCSV() {
      var rows = getFilteredSorted();
      if (rows.length === 0) return;

      var catIds = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
      var header = ['LINE UID', '表示名', '日時', '合計', 'Health', 'Skills', 'ランク', 'タイプ']
        .concat(catIds.map(function (id) { return id + '_' + CATEGORY_NAMES[id]; }));

      var csvRows = [header.join(',')];
      rows.forEach(function (r) {
        var d = new Date(r.date);
        var dateStr = d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate() + ' ' +
                      String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
        var row = [
          '"' + (r.lineUid || '') + '"',
          '"' + (r.displayName || '') + '"',
          '"' + dateStr + '"',
          r.total, r.healthTotal, r.skillsTotal,
          r.level, r.type
        ].concat(catIds.map(function (id) { return (r.categories && r.categories[id]) || 0; }));
        csvRows.push(row.join(','));
      });

      var bom = '\uFEFF';
      var blob = new Blob([bom + csvRows.join('\n')], { type: 'text/csv;charset=utf-8' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'brain_capital_results_' + new Date().toISOString().slice(0, 10) + '.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    // ---- Event Listeners ----
    document.getElementById('search').addEventListener('input', renderTable);
    document.getElementById('sort-select').addEventListener('change', renderTable);
    document.getElementById('btn-export').addEventListener('click', exportCSV);

    document.getElementById('btn-clear').addEventListener('click', function () {
      if (!confirm('全ての結果データを削除しますか？この操作は元に戻せません。')) return;
      if (!sb) return;

      sb.from('assessment_results')
        .delete()
        .neq('id', '00000000-0000-0000-0000-000000000000')  // delete all rows
        .then(function (res) {
          if (res.error) {
            console.error('Delete failed:', res.error.message);
            alert('削除に失敗しました: ' + res.error.message);
          } else {
            allResults = [];
            renderAll();
          }
        });
    });

    // Table row click -> detail
    document.getElementById('results-tbody').addEventListener('click', function (e) {
      var tr = e.target.closest('tr');
      if (!tr) return;
      var idx = parseInt(tr.getAttribute('data-idx'), 10);
      var rows = getFilteredSorted();
      if (rows[idx]) showDetail(rows[idx]);
    });

    // Modal close
    document.getElementById('modal-close').addEventListener('click', function () {
      document.getElementById('modal-overlay').classList.remove('active');
    });
    document.getElementById('modal-overlay').addEventListener('click', function (e) {
      if (e.target === this) this.classList.remove('active');
    });

    // Init
    loadResults();
  })();
  </script>
</body>
</html>
